generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String    @id @default(cuid())
  name      String
  cnpj      String?   @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  phone     String?
  email     String?
  isActive  Boolean   @default(true)
  students  Student[]
  users     User[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  fullName     String
  role         UserRole @default(STUDENT)
  companyId    String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company? @relation(fields: [companyId], references: [id])
}

model Student {
  id                 String                    @id @default(cuid())
  fullName           String
  email              String                    @unique
  companyId          String
  isActive           Boolean                   @default(true)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  mustChangePassword Boolean                   @default(true)
  passwordHash       String
  cpf                String?                   @unique
  certificates       Certificate[]
  company            Company                   @relation(fields: [companyId], references: [id])
  courses            StudentCourse[]
  enrollments        StudentCourseEnrollment[]
  examAttempts       StudentExamAttempt[]
  lessonProgress     StudentLessonProgress[]
  orders             Order[]
}

model Course {
  id          String  @id @default(cuid())
  title       String
  description String?
  isActive    Boolean @default(true)

  //  pagamento
  isPaid     Boolean @default(false)
  priceCents Int? // ex: 19990 = R$199,90 (só quando isPaid = true)

  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  imageUrl      String?
  workloadHours Int?
  certificates  Certificate[]
  exam          Exam?
  libraryItems  LibraryItem[]
  modules       Module[]
  students      StudentCourse[]
  enrollments   StudentCourseEnrollment[]

  // ✅ relations novas
  orderItems OrderItem[]
}

model Module {
  id            String   @id @default(cuid())
  title         String
  order         Int
  courseId      String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  workloadHours Int?
  lessons       Lesson[]
  course        Course   @relation(fields: [courseId], references: [id])
}

model Lesson {
  id        String                  @id @default(cuid())
  title     String
  videoUrl  String?
  order     Int
  moduleId  String
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt
  module    Module                  @relation(fields: [moduleId], references: [id])
  progress  StudentLessonProgress[]
}

model StudentCourseEnrollment {
  id          String    @id @default(cuid())
  studentId   String
  courseId    String
  status      String    @default("ACTIVE")
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  course      Course    @relation(fields: [courseId], references: [id])
  student     Student   @relation(fields: [studentId], references: [id])
  directorName String
  engineerName String
  
  @@unique([studentId, courseId])
}

model StudentLessonProgress {
  id              String    @id @default(cuid())
  studentId       String
  lessonId        String
  completed       Boolean   @default(false)
  completedAt     DateTime?
  durationSeconds Int       @default(0)
  finishedVideo   Boolean   @default(false)
  lastPosition    Int       @default(0)
  updatedAt       DateTime  @updatedAt
  watchedSeconds  Int       @default(0)
  lesson          Lesson    @relation(fields: [lessonId], references: [id])
  student         Student   @relation(fields: [studentId], references: [id])

  @@unique([studentId, lessonId])
  @@index([studentId])
  @@index([lessonId])
}

model StudentCourse {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])

  @@unique([studentId, courseId])
}

model LibraryItem {
  id           String   @id @default(cuid())
  courseId     String
  title        String
  description  String?
  fileUrl      String
  fileKey      String?
  originalName String?
  mimeType     String?
  sizeBytes    Int?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  course       Course   @relation(fields: [courseId], references: [id])

  @@index([courseId])
}

model Exam {
  id        String               @id @default(cuid())
  courseId  String               @unique
  title     String
  passScore Int                  @default(70)
  isActive  Boolean              @default(true)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  course    Course               @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions ExamQuestion[]
  attempts  StudentExamAttempt[]
}

model ExamQuestion {
  id      String              @id @default(cuid())
  examId  String
  title   String
  order   Int
  options ExamOption[]
  exam    Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers StudentExamAnswer[]
}

model ExamOption {
  id         String              @id @default(cuid())
  questionId String
  label      String
  isCorrect  Boolean             @default(false)
  question   ExamQuestion        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  answers    StudentExamAnswer[]
}

model StudentExamAttempt {
  id            String              @id @default(cuid())
  examId        String
  studentId     String
  attemptNumber Int
  finishedAt    DateTime?
  passed        Boolean             @default(false)
  scorePercent  Int?
  startedAt     DateTime            @default(now())
  answers       StudentExamAnswer[]
  exam          Exam                @relation(fields: [examId], references: [id], onDelete: Cascade)
  student       Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, examId, attemptNumber])
  @@index([studentId, examId])
}

model StudentExamAnswer {
  id         String             @id @default(cuid())
  attemptId  String
  questionId String
  optionId   String
  attempt    StudentExamAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  option     ExamOption         @relation(fields: [optionId], references: [id], onDelete: Cascade)
  question   ExamQuestion       @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model Certificate {
  id           String   @id @default(cuid())
  studentId    String
  courseId     String
  attemptId    String?
  scorePercent Int
  issuedAt     DateTime @default(now())
  course       Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

enum UserRole {
  ADMIN
  OPERATOR
  MANAGER
  STUDENT
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  CANCELED
  EXPIRED
}

enum BillingType {
  PIX
  CREDIT_CARD
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELED
  OVERDUE
  REFUNDED
}

model Order {
  id         String      @id @default(cuid())
  studentId  String
  status     OrderStatus @default(PENDING_PAYMENT)
  totalCents Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  expiresAt  DateTime?

  student Student     @relation(fields: [studentId], references: [id])
  items   OrderItem[]
  payment Payment?
}

model OrderItem {
  id             String @id @default(cuid())
  orderId        String
  courseId       String
  unitPriceCents Int

  order  Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id])

  @@unique([orderId, courseId])
  @@index([orderId])
  @@index([courseId])
}

model Payment {
  id          String        @id @default(cuid())
  orderId     String        @unique
  billingType BillingType
  status      PaymentStatus @default(PENDING)

  // Asaas
  provider          String  @default("ASAAS")
  providerPaymentId String? @unique
  checkoutSessionId String?
  checkoutUrl       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order  Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events PaymentEvent[]
}

model PaymentEvent {
  id                String   @id @default(cuid())
  provider          String   @default("ASAAS")
  eventType         String
  providerEventId   String?  @unique
  providerPaymentId String?
  payload           Json
  receivedAt        DateTime @default(now())

  paymentId String?
  payment   Payment? @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([providerPaymentId])
  @@index([paymentId])
}
